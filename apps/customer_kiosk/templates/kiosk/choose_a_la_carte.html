{% extends 'kiosk/base.html' %}
{% load static kiosk_extras %}

{% block title %}{% if kiosk_ui %}{{ kiosk_ui.nav.a_la_carte }}{% else %}A La Carte{% endif %}{% endblock %}

{% block content %}
{% if kiosk_ui %}
<h2 class="kiosk-page-title">{{ kiosk_ui.nav.a_la_carte }}</h2>
{% else %}
<h2 class="kiosk-page-title">A La Carte</h2>
{% endif %}
        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}
<div class="kiosk-toast kiosk-toast--success" style="display:none">Added to cart</div>
<style>
    .kiosk-a-la-carte-size .kiosk-size-pill {
        flex-direction: column;
        gap: 0.35rem;
    }
    .kiosk-a-la-carte-size .kiosk-size-price {
        display: none;
    }
    .kiosk-alacarte-price {
        margin-top: 0.6rem;
        font-weight: 600;
        color: #fff;
        font-size: 0.95rem;
    }
</style>
<form method="post" class="kiosk-combo-form kiosk-sizing-view" data-cart-endpoint="{% url 'customer_kiosk:api_add_to_cart' %}">
    {% csrf_token %}
    {% if editing_index %}
    <input type="hidden" name="editing_index" value="{{ editing_index }}">
    {% endif %}
    <div class="kiosk-combo-stack">
                <section class="kiosk-single-card">
                    <div class="kiosk-combo-card__header">
                    {% if kiosk_ui and kiosk_ui.sections.items %}
                    <h3 class="section-title">{{ kiosk_ui.sections.items }}</h3>
                    {% else %}
                    <h3 class="section-title">Items</h3>
                    {% endif %}
                    {% if kiosk_ui and kiosk_ui.defaults|get_item:"Select one" %}
                    <p class="kiosk-subtitle">{{ kiosk_ui.defaults|get_item:"Select one" }}</p>
                    {% else %}
                    <p class="kiosk-subtitle">Select one</p>
                    {% endif %}
                    </div>
                <ul class="options-list options-list--grid options-list--compact options-list--entrees entree-options">
                    {% for item in items %}
                    <li>
                        <label class="option-tile">
                            <input type="radio" name="item" value="{{ item.name }}" {% if forloop.first %}required{% endif %} {% if selected_item == item.name %}checked{% endif %}>
                            {% if item.image %}
                                <img src="{% static item.image %}" alt="{{ item.translated_name|default:item.name }}" class="option-tile__image" loading="lazy">
                            {% endif %}
                                <span class="option-tile__text">{{ item.translated_name|default:item.name }}</span>
                        </label>
                    </li>
                {% endfor %}
            </ul>
        </section>

        <section class="kiosk-size-card">
            <div class="kiosk-combo-card__header">
                <h3 class="section-title">Size</h3>
                <p class="kiosk-subtitle">Pick one</p>
            </div>
            <div class="kiosk-size-toggle kiosk-a-la-carte-size">
                {% for size in sizes %}
                <label class="kiosk-size-pill">
                    <input type="radio" name="size" value="{{ size.code }}" {% if size.code == selected_size %}checked{% endif %}>
                    <span>{{ size.label }}</span>
                    <span class="kiosk-size-price" data-size="{{ size.code }}">+${{ size.price|floatformat:2 }}</span>
                </label>
                {% endfor %}
            </div>
            <p class="kiosk-subtitle__hint kiosk-alacarte-price">{% if kiosk_ui and kiosk_ui.size and kiosk_ui.size.price_label %}{{ kiosk_ui.size.price_label }}{% else %}Price:{% endif %} <strong id="kiosk-alacarte-price">--</strong></p>
        </section>
    </div>

    <div class="kiosk-actions">
        <a href="{% url 'customer_kiosk:cart' %}" class="button button-secondary">View Cart</a>
        <button type="button" class="button button-secondary" id="kiosk-clear-alacarte">Clear</button>
        <div class="kiosk-actions__center">
            <div class="entree-pager">
                <button type="button" class="btn btn-secondary btn-compact" id="entree-prev">Prev</button>
                <span id="entree-page-label">Page 1</span>
                <button type="button" class="btn btn-secondary btn-compact" id="entree-next">Next</button>
            </div>
        </div>
        <span class="kiosk-cart-total-pill" id="kiosk-cart-total-pill" data-total="{{ cart_total|default:0 }}">Cart Total: ${{ cart_total|default:0|floatformat:2 }}</span>
        <button type="submit" class="button">{% if is_editing %}Save Changes{% else %}Add to Cart{% endif %}</button>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<style>
.kiosk-cart-total-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: #111;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.15);
    padding: 0.45rem 0.85rem;
    border-radius: 999px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}
</style>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const entreeList = Array.from(document.querySelectorAll(".entree-options li"));
    const pageLabel = document.getElementById("entree-page-label");
    const prevBtn = document.getElementById("entree-prev");
    const nextBtn = document.getElementById("entree-next");
    const pageSize = 8;

    if (!entreeList.length || !pageLabel || !prevBtn || !nextBtn) return;

    let page = 0;
    const totalPages = Math.max(1, Math.ceil(entreeList.length / pageSize));

    function render() {
        entreeList.forEach((el, idx) => {
            const pageIndex = Math.floor(idx / pageSize);
            el.style.display = pageIndex === page ? "" : "none";
        });
        pageLabel.textContent = `Page ${page + 1} of ${totalPages}`;
        prevBtn.disabled = page === 0;
        nextBtn.disabled = page >= totalPages - 1;
    }

    prevBtn.addEventListener("click", () => {
        if (page > 0) { page -= 1; render(); }
    });
    nextBtn.addEventListener("click", () => {
        if (page < totalPages - 1) { page += 1; render(); }
    });

    render();
});
</script>
{{ alacarte_payload|json_script:"kiosk-alacarte-ctx" }}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const payloadEl = document.getElementById("kiosk-alacarte-ctx");
    if (!payloadEl) return;
    const ctx = JSON.parse(payloadEl.textContent);
    const basePrices = Object.fromEntries(ctx.sizes.map(size => [size.code, size.price]));
    const premiumSizePrices = Object.fromEntries(ctx.premiumSizePrices.map(size => [size.code, size.price]));
    const premiumItems = new Set(ctx.premiumItems);

    const priceNodes = document.querySelectorAll(".kiosk-size-price");
    const priceLabel = document.getElementById("kiosk-alacarte-price");

    const updatePrices = () => {
        const selectedItem = document.querySelector('input[name="item"]:checked');
        const itemName = selectedItem ? selectedItem.value : null;
        const usePremium = itemName && premiumItems.has(itemName);
        const selectedSize = document.querySelector('input[name="size"]:checked');
        const sizeCodeSelected = selectedSize ? selectedSize.value : null;
        priceNodes.forEach(node => {
            const sizeCode = node.dataset.size;
            const price = usePremium ? (premiumSizePrices[sizeCode] ?? basePrices[sizeCode] ?? 0) :
                (basePrices[sizeCode] ?? 0);
            node.textContent = `+$${price.toFixed(2)}`;
        });

        if (priceLabel && sizeCodeSelected) {
            const displayPrice = usePremium
                ? (premiumSizePrices[sizeCodeSelected] ?? basePrices[sizeCodeSelected] ?? 0)
                : (basePrices[sizeCodeSelected] ?? 0);
            priceLabel.textContent = `$${displayPrice.toFixed(2)}`;
        }
    };

    document.querySelectorAll('input[name="item"]').forEach(input => {
        input.addEventListener("change", updatePrices);
    });
    document.querySelectorAll('input[name="size"]').forEach(input => {
        input.addEventListener("change", updatePrices);
    });

    updatePrices();

    const clearBtn = document.getElementById("kiosk-clear-alacarte");
    if (clearBtn) {
        clearBtn.addEventListener("click", () => {
            document.querySelectorAll('input[name="item"]').forEach(el => { el.checked = false; });
            document.querySelectorAll('input[name="size"]').forEach(el => { el.checked = false; });
            if (priceLabel) priceLabel.textContent = "--";
            priceNodes.forEach(node => node.textContent = "");
        });
    }
});
</script>
<script>
// Async add-to-cart for a la carte
document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector(".kiosk-combo-form");
    const endpoint = form?.dataset.cartEndpoint;
    const toast = document.querySelector(".kiosk-toast");
    const totalPill = document.getElementById("kiosk-cart-total-pill");
    const setTotal = (val) => {
        if (!totalPill) return;
        const num = Number(val);
        const formatted = Number.isFinite(num) ? num.toFixed(2) : "--";
        totalPill.textContent = `Cart Total: $${formatted}`;
    };
    if (totalPill?.dataset.total) {
        setTotal(totalPill.dataset.total);
    }
    if (!form || !endpoint) return;

    form.addEventListener("submit", (e) => {
        e.preventDefault();
        const item = form.querySelector('input[name="item"]:checked');
        const size = form.querySelector('input[name="size"]:checked');
        if (!item || !size) {
            form.submit();
            return;
        }
        const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
        const data = new FormData();
        data.append("category", "a_la_carte");
        data.append("item", item.value);
        data.append("size", size.value);

        fetch(endpoint, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrf || "",
                "Accept": "application/json",
            },
            body: data,
        }).then(resp => resp.json()).then(payload => {
            if (payload.status === "ok") {
                if (payload.cart_total !== undefined) {
                    setTotal(payload.cart_total);
                }
                if (toast) {
                    toast.style.display = "block";
                    toast.classList.add("kiosk-toast--show");
                    setTimeout(() => {
                        toast.classList.remove("kiosk-toast--show");
                        toast.style.display = "none";
                    }, 2200);
                }
            } else {
                form.submit();
            }
        }).catch(() => form.submit());
    });
});
</script>
{% endblock %}
